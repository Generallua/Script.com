local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

_G.ESPEnabled = true      -- เปิด/ปิด ESP
_G.OnlyEnemy = true       -- แสดงเฉพาะศัตรู

local lines = {}

local function createLine()
    local line = Drawing.new("Line")
    line.Thickness = 1.5
    line.Transparency = 1
    line.Visible = false
    return line
end

local function getTeamColor(player)
    if player.Team and player.Team.TeamColor then
        return player.Team.TeamColor.Color
    else
        return Color3.new(1,1,1)
    end
end

local function applyHighlight(player)
    if player.Character then
        if not player.Character:FindFirstChild("ESP_Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "ESP_Highlight"
            highlight.RobloxLocked = true
            highlight.Adornee = player.Character
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            highlight.Parent = player.Character
        end
        local color = getTeamColor(player)
        player.Character.ESP_Highlight.FillColor = color
        player.Character.ESP_Highlight.Enabled = _G.ESPEnabled and (not _G.OnlyEnemy or player.Team ~= LocalPlayer.Team)
    end
end

RunService.RenderStepped:Connect(function()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if not lines[player] then
                lines[player] = createLine()
            end
            local line = lines[player]

            if _G.ESPEnabled then
                local show = not _G.OnlyEnemy or (player.Team ~= LocalPlayer.Team)
                applyHighlight(player)
                if show then
                    local pos, onScreen = Camera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
                    if onScreen then
                        line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
                        line.To = Vector2.new(pos.X, pos.Y)
                        line.Color = getTeamColor(player)
                        line.Visible = true
                    else
                        line.Visible = false
                    end
                else
                    line.Visible = false
                end
            else
                line.Visible = false
                if player.Character and player.Character:FindFirstChild("ESP_Highlight") then
                    player.Character.ESP_Highlight.Enabled = false
                end
            end
        elseif lines[player] then
            lines[player].Visible = false
        end
    end
end)
